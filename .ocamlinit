#directory "/Users/jrrk/.opam/default/lib/xml-light";;
#print_depth 100000;;
#print_length 1000000;;

open Vxml
open Template_ilang

let xmlf = "obj_dir/Vtimer.xml";;

let errlst = ref [];;
let (line,range,rwxml,xml,mods,toplst,topattr) = Vxml.translate errlst xmlf;;

let f k = Hashtbl.find Vxml.modules k;;
let p k = Hashtbl.find Vxml.packages k;;
let d f = Vxml.debug f (Hashtbl.find Vxml.modules f)
let h k = Hashtbl.find Vxml.hierarchy k;;

let othcnt = (
List.length !exprothlst,
List.length !stmtothlst,
List.length !portothlst,
List.length !iothlst,
List.length !csothlst,
List.length !bgnothlst,
List.length !itmothlst,
List.length !catothlst,
List.length !cellothlst,
List.length !posneglst,
List.length !typothlst,
List.length !memothlst
);;

let dumps s = "\""^s^"\""
let dumpstrlst lst = "["^String.concat ";\n\t" (List.map dumps lst)^"]"

let rec dumpdir = function
| Dinput -> "input"
| Doutput -> "output"
| Dinout -> "inout"
| Dvif s -> "Dvif "^dumps !s
| Dinam str -> "Dinam "^dumps str
| Dport(str1, int1, dirop, str2, str_lst) ->
     "Dport("^dumps str1 ^", "^ string_of_int int1 ^", "^ dumpdir dirop ^", "^ dumps str2 ^", "^ dumpstrlst str_lst^")"
| Dunknown -> "Dunknown"

let wref = ref [];;
let err = ref "";;
let flt' oth = String.concat ":" (List.map (tokencnv (ref 0)) oth);;
let _ = Hashtbl.iter (fun k (_,modul) -> 
let iolst = List.map (fun (io, (origin, typ', dir, kind', lst)) -> 
    (io,dumpdir dir,findmembers' typ')
    ) !(modul.io) in
let wlst = iolst @ List.map (fun (id, (origin, typ', kind', n)) ->
    (id,"width",findmembers' typ')) !(modul.v) in
wref := wlst;
let wlst' = List.map (fun (id, dir, (rng,_,_)) -> match rng with 
| BIT :: [] -> (1, dir, id)
| ARNG(hi,lo) :: [] -> (hi-lo+1, dir, id)
| oth -> err := flt' (comment oth); failwith "rng"
) wlst in
let cellst' = [] in
let proclst' = [] in
let asgnlst' = List.map (function (_, VRF(dst, typ, []), e) -> dst,flt'(expr modul e)) !(modul.ca) in
template_ilang stdout "timer" wlst' cellst' proclst' asgnlst') Vxml.modules;;

